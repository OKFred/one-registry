name: sync-images

on:
    push:
    # è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 8 å°æ—¶è¿è¡Œä¸€æ¬¡
    schedule:
        - cron: "0 */8 * * *"

jobs:
    job1:
        runs-on: ubuntu-22.04
        env:
            MY_SRC_REGISTRY_USERNAME: ${{ secrets.MY_SRC_REGISTRY_USERNAME }}
            MY_SRC_REGISTRY_PASSWORD: ${{ secrets.MY_SRC_REGISTRY_PASSWORD }}
            MY_SRC_REGISTRY_URL: ${{ secrets.MY_SRC_REGISTRY_URL }}
            MY_DEST_REGISTRY_USERNAME: ${{ secrets.MY_DEST_REGISTRY_USERNAME }}
            MY_DEST_REGISTRY_PASSWORD: ${{ secrets.MY_DEST_REGISTRY_PASSWORD }}
            MY_DEST_REGISTRY_URL: ${{ secrets.MY_DEST_REGISTRY_URL }}
            MY_ALIYUN_REGISTRY_USERNAME: ${{ secrets.MY_ALIYUN_REGISTRY_USERNAME }}
            MY_ALIYUN_REGISTRY_PASSWORD: ${{ secrets.MY_ALIYUN_REGISTRY_PASSWORD }}
            MY_ALIYUN_REGISTRY_NAMESPACED_URL: ${{ secrets.MY_ALIYUN_REGISTRY_NAMESPACED_URL }}
            MY_ALIYUN_REGISTRY_REGION_SERVER: ${{ secrets.MY_ALIYUN_REGISTRY_REGION_SERVER }}
        steps:
            - name: Clone repository
              uses: actions/checkout@v4
            - name: registry login & sync ğŸš©ä»“åº“ç™»å½•&é•œåƒåŒæ­¥
              shell: bash
              run: |
                  date
                  echo 'hello there! Ready to sync all repos--å‡†å¤‡åŒæ­¥é•œåƒ'
                  source ./.github/scripts/main.sh
                  main $MY_SRC_REGISTRY_USERNAME $MY_SRC_REGISTRY_PASSWORD $MY_SRC_REGISTRY_URL $MY_DEST_REGISTRY_USERNAME $MY_DEST_REGISTRY_PASSWORD $MY_DEST_REGISTRY_URL $MY_ALIYUN_REGISTRY_USERNAME $MY_ALIYUN_REGISTRY_PASSWORD $MY_ALIYUN_REGISTRY_NAMESPACED_URL
            - name: Make a images.yaml to feed aliyun-âœï¸æŠ•å–‚æ–‡ä»¶ç»™é˜¿é‡Œäº‘
              shell: bash
              run: |
                  date
                  echo 'Ready to sync all to Aliyun--å‡†å¤‡åŒæ­¥é•œåƒåˆ°é˜¿é‡Œäº‘'
                  cat ./images.yaml
                  echo "ğŸ‘†ä¸ºå¾…åŒæ­¥çš„é•œåƒåˆ—è¡¨ã€‚"
                  cat ./auth.yaml
                  echo "ğŸ‘†ä¸ºé˜¿é‡Œäº‘çš„ç™»å½•ä¿¡æ¯ã€‚"
            - uses: hhyasdf/image-sync-action@v1.1
              with:
                  auth_file: ./auth.yaml # The auth information file of registries, optional.
                  images_file: ./images.yaml # The images file descirbes which images need to sync, always needed.
                  version: latest # The version of image-syncer, use the latest version if not specified.
                  proc: 6 # The max number of goroutines to sync images, default value is 5.
